# Template file for 'brother-mfc-l3730cdn'
pkgname=brother-mfc-l3730cdn
version=1.0.2
revision=2
_upstream_rev=0
_printer_model=mfcl3730cdn
maintainer="2xsaiko <pkg@dblsaiko.net>"
homepage="http://support.brother.com/g/b/downloadtop.aspx?c=us&lang=en&prod=${_printer_model}_all"
license="GPL-2"
short_desc="Brother printer driver for MFC-L3730CDN"
distfiles="https://download.brother.com/welcome/dlf103931/${_printer_model}pdrv-${version}-${_upstream_rev}.i386.deb"
checksum="55b6b737e32f5fee67cdebeafadce10b83062b885f9b126f4d4a112ea8f377ac"
archs="i686 x86_64"
create_wrksrc=yes
depends="cups"
hostmakedepends="tar"
mutable_files="/opt/brother/Printers/${_printer_model}/inf/br${_printer_model}rc"
nopie=yes

if [ "$XBPS_TARGET_MACHINE" = "x86_64" ]; then
	depends+=" glibc-32bit"
fi

do_extract() {
	ar x ${XBPS_SRCDISTDIR}/${pkgname}-${version}/${_printer_model}pdrv-${version}-${_upstream_rev}.i386.deb
	mkdir data
	tar xzpvf data.tar.gz -C data
}

do_install() {
	vmkdir /opt/brother/Printers/${_printer_model}
	vmkdir /opt/brother/Printers/${_printer_model}/cupswrapper

	vcopy data/opt/brother/Printers/${_printer_model}/inf /opt/brother/Printers/${_printer_model}

	for file in data/opt/brother/Printers/${_printer_model}/lpd/*; do
		vinstall $file 755 /opt/brother/Printers/${_printer_model}/lpd
	done

	# Printer configuration utility
	vbin data/usr/bin/brprintconf_${_printer_model}

	# Install wrapping tools for CUPS
	vinstall data/opt/brother/Printers/${_printer_model}/cupswrapper/cupswrapper${_printer_model} 755 /opt/brother/Printers/${_printer_model}/cupswrapper

	# You have to install the cupswrapper where it wants to be and then symbolically link to it; otherwise the $basedir that is assumed in the script generates confused paths
	vinstall data/opt/brother/Printers/${_printer_model}/cupswrapper/brother_lpdwrapper_${_printer_model} 755 /opt/brother/Printers/${_printer_model}/cupswrapper
	vmkdir /usr/lib/cups/filter
	ln -s /opt/brother/Printers/${_printer_model}/cupswrapper/brother_lpdwrapper_${_printer_model} ${DESTDIR}/usr/lib/cups/filter/brother_lpdwrapper_${_printer_model}

	vinstall data/opt/brother/Printers/${_printer_model}/cupswrapper/brother_${_printer_model}_printer_en.ppd 644 /usr/share/ppd/Brother
}
